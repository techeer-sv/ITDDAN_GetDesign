# 파일 동기화 구현 방식

## 1. 기본 동기화 구현

### 1.1 원격 → 로컬 동기화 (Remote to Local Sync)
1. **변경사항 요청**
   - 클라이언트 앱이 동기화 서비스의 getChanges API 호출
   - 특정 타임스탬프 이후의 변경사항 요청
   - 주기적인 폴링 방식으로 동작

2. **메타데이터 조회**
   - 동기화 서비스가 파일 메타데이터 DB 쿼리 실행
   - 생성/업데이트된 파일 ID 목록 반환
   - 필요시 전체 메타데이터 정보 포함

3. **로컬 상태 확인**
   - 클라이언트가 로컬 DB 참조
   - 수신된 변경사항 목록과 로컬 파일 비교
   - 동기화 필요성 판단

4. **파일 다운로드 및 업데이트**
   - 필요한 파일을 S3에서 직접 다운로드
   - 로컬 폴더에 파일 업데이트
   - 로컬 DB 메타데이터 갱신

### 1.2 로컬 → 원격 동기화 (Local to Remote Sync)
1. **변경 감지**
   - OS 파일 시스템 API 사용
     - Windows: File System Watcher
     - macOS: FS Events
     - Linux: inotify
   - 로컬 폴더 변경사항 실시간 감지
     - 파일 생성
     - 파일 수정
     - 파일 삭제
     - 이름 변경

2. **변경사항 동기화**
   - 감지된 변경사항 원격 저장소에 업로드
   - 파일 메타데이터 DB 업데이트
   - 동기화 상태 갱신

## 2. 빠른 동기화 (Making Sync Fast)

### 2.1 적응형 폴링 (Adaptive Polling)
- **동작 방식**
  - 변경 이력과 사용자 활동에 따라 폴링 주기 동적 조정
  - 활동이 많을 때: 짧은 주기 (예: 30초)
  - 활동이 적을 때: 긴 주기 (예: 5분)

- **장점**
  - 서버 부하 최적화
  - 리소스 효율적 사용
  - 실시간성과 효율성의 균형

### 2.2 델타 동기화 (Delta Sync)
- **동작 방식**
  - 파일 전체가 아닌 변경된 부분만 전송
  - 청크 단위로 파일 분할
  - 변경된 청크만 식별하여 동기화

- **장점**
  - 네트워크 대역폭 절약
  - 동기화 속도 향상
  - 리소스 사용 최적화

## 3. 일관된 동기화 (Making Sync Consistent)

### 3.1 데이터베이스 직접 폴링
- **동작 방식**
  - 동기화 서비스가 DB를 직접 쿼리
  - folder ID와 타임스탬프로 변경사항 조회
  - 변경된 파일/청크 메타데이터 확인

- **특징**
  - 구현이 단순하고 직관적
  - 소규모 시스템에 적합
  - 확장성 제한적

### 3.2 커서가 있는 이벤트 버스
- **동작 방식**
  - Kafka와 같은 이벤트 스트림 사용
  - 모든 변경을 이벤트로 기록
  - 클라이언트가 sync cursor로 진행 상태 추적

- **장점**
  - 확장성이 뛰어남
  - 감사 추적 용이
  - 장애 복구 강건성

### 3.3 조정 (Reconciliation)
- **동작 방식**
  - 주기적으로 전체 동기화 상태 검증
  - 로컬 DB와 원격 메타데이터 비교
  - 불일치 발견 시 강제 동기화

- **필요성**
  - 실시간 동기화의 보완책
  - 장기적 데이터 일관성 보장
  - 에지 케이스 처리
