name: ğŸ” Coding Test Verification

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master]

jobs:
  test-solutions:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ” Detect changed files
      id: changes
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # PRì—ì„œ ë³€ê²½ëœ íŒŒì¼ë“¤ ê°ì§€
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > changed_files.txt
        else
          # Pushì—ì„œ ë³€ê²½ëœ íŒŒì¼ë“¤ ê°ì§€
          git diff --name-only HEAD~1 HEAD > changed_files.txt
        fi
        
        # .md íŒŒì¼ì´ ì•„ë‹Œ ì½”ë“œ íŒŒì¼ë“¤ë§Œ í•„í„°ë§
        grep -v '\.md$' changed_files.txt | grep -E '\.(py|js|ts|java|go)$' > code_files.txt || true
        
        if [ -s code_files.txt ]; then
          echo "has_code_files=true" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ ë³€ê²½ëœ ì½”ë“œ íŒŒì¼ë“¤:"
          cat code_files.txt
        else
          echo "has_code_files=false" >> $GITHUB_OUTPUT
          echo "âŒ ë³€ê²½ëœ ì½”ë“œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
        fi

    - name: ğŸ Setup Python
      if: steps.changes.outputs.has_code_files == 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: â˜• Setup Java
      if: steps.changes.outputs.has_code_files == 'true'
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ğŸš€ Setup Node.js
      if: steps.changes.outputs.has_code_files == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ğŸ¹ Setup Go
      if: steps.changes.outputs.has_code_files == 'true'
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: ğŸ§ª Run code tests
      if: steps.changes.outputs.has_code_files == 'true'
      run: |
        echo "ğŸ” ì½”ë“œ íŒŒì¼ ì‹¤í–‰ ë° ê²€ì¦ ì‹œì‘..."
        
        success_count=0
        total_count=0
        
        while IFS= read -r file; do
          if [ ! -f "$file" ]; then
            continue
          fi
          
          echo "ğŸ“„ Testing: $file"
          total_count=$((total_count + 1))
          
          # íŒŒì¼ í™•ì¥ìì— ë”°ë¼ ì‹¤í–‰
          case "$file" in
            *.py)
              echo "ğŸ Running Python file..."
              if timeout 30s python3 "$file"; then
                echo "âœ… $file ì‹¤í–‰ ì„±ê³µ"
                success_count=$((success_count + 1))
              else
                echo "âŒ $file ì‹¤í–‰ ì‹¤íŒ¨"
              fi
              ;;
            *.java)
              echo "â˜• Running Java file..."
              class_name=$(basename "$file" .java)
              if javac "$file" && timeout 30s java "$class_name"; then
                echo "âœ… $file ì‹¤í–‰ ì„±ê³µ"
                success_count=$((success_count + 1))
              else
                echo "âŒ $file ì‹¤í–‰ ì‹¤íŒ¨"
              fi
              ;;
            *.js)
              echo "ğŸš€ Running JavaScript file..."
              if timeout 30s node "$file"; then
                echo "âœ… $file ì‹¤í–‰ ì„±ê³µ"
                success_count=$((success_count + 1))
              else
                echo "âŒ $file ì‹¤í–‰ ì‹¤íŒ¨"
              fi
              ;;
                        *.go)
              echo "ğŸ¹ Running Go file..."
              if timeout 30s go run "$file"; then
                echo "âœ… $file ì‹¤í–‰ ì„±ê³µ"
                success_count=$((success_count + 1))
              else
                echo "âŒ $file ì‹¤í–‰ ì‹¤íŒ¨"
              fi
              ;;
            *)
              echo "âš ï¸ $file: ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹"
              ;;
          esac
          echo "---"
        done < code_files.txt
        
        echo "ğŸ“Š ê²°ê³¼ ìš”ì•½:"
        echo "- ì´ íŒŒì¼ ìˆ˜: $total_count"
        echo "- ì„±ê³µí•œ íŒŒì¼: $success_count"
        echo "- ì‹¤íŒ¨í•œ íŒŒì¼: $((total_count - success_count))"
        
        if [ $success_count -eq $total_count ] && [ $total_count -gt 0 ]; then
          echo "ğŸ‰ ëª¨ë“  ì½”ë“œ íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!"
          exit 0
        elif [ $total_count -eq 0 ]; then
          echo "â„¹ï¸ ì‹¤í–‰í•  ì½”ë“œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          exit 0
        else
          echo "ğŸ’¥ ì¼ë¶€ ì½”ë“œ íŒŒì¼ ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          exit 1
        fi

    - name: ğŸ“ Comment on PR
      if: github.event_name == 'pull_request' && steps.changes.outputs.has_code_files == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // ì›Œí¬í”Œë¡œìš° ê²°ê³¼ì— ë”°ë¥¸ ì½”ë©˜íŠ¸ ìƒì„±
          const workflowUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
          
          let comment = `## ğŸ” ì½”ë”© í…ŒìŠ¤íŠ¸ ê²€ì¦ ê²°ê³¼\n\n`;
          comment += `ìë™ìœ¼ë¡œ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì—¬ ê²€ì¦í–ˆìŠµë‹ˆë‹¤.\n\n`;
          comment += `ğŸ“Š [ìƒì„¸ ê²°ê³¼ ë³´ê¸°](${workflowUrl})\n\n`;
          
          if (process.env.GITHUB_JOB_STATUS === 'success') {
            comment += `âœ… **ëª¨ë“  ì½”ë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!**\n`;
          } else {
            comment += `âŒ **ì¼ë¶€ ì½”ë“œ ì‹¤í–‰ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.**\n`;
            comment += `ìœ„ ë§í¬ì—ì„œ ìƒì„¸í•œ ì˜¤ë¥˜ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\n`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          }); 