name: üîç Coding Test Verification

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: üîç Detect changed files
      id: changes
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # PRÏóêÏÑú Î≥ÄÍ≤ΩÎêú ÌååÏùºÎì§ Í∞êÏßÄ
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > changed_files.txt
        else
          # PushÏóêÏÑú Î≥ÄÍ≤ΩÎêú ÌååÏùºÎì§ Í∞êÏßÄ
          git diff --name-only HEAD~1 HEAD > changed_files.txt
        fi
        
        # .md ÌååÏùºÏù¥ ÏïÑÎãå ÏΩîÎìú ÌååÏùºÎì§Îßå ÌïÑÌÑ∞ÎßÅ
        grep -v '\.md$' changed_files.txt | grep -E '\.(py|js|ts|java|go)$' > code_files.txt || true
        
        if [ -s code_files.txt ]; then
          echo "has_code_files=true" >> $GITHUB_OUTPUT
          echo "üìã Î≥ÄÍ≤ΩÎêú ÏΩîÎìú ÌååÏùºÎì§:"
          cat code_files.txt
        else
          echo "has_code_files=false" >> $GITHUB_OUTPUT
          echo "‚ùå Î≥ÄÍ≤ΩÎêú ÏΩîÎìú ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§."
        fi

    - name: üêç Setup Python
      if: steps.changes.outputs.has_code_files == 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ‚òï Setup Java
      if: steps.changes.outputs.has_code_files == 'true'
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: üöÄ Setup Node.js
      if: steps.changes.outputs.has_code_files == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: üêπ Setup Go
      if: steps.changes.outputs.has_code_files == 'true'
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: üîç Install Linters
      if: steps.changes.outputs.has_code_files == 'true'
      run: |
        echo "üîß Installing linters for all languages..."
        
        # Python linters
        python3 -m pip install --upgrade pip
        pip install flake8 black isort
        
        # JavaScript linters
        npm install -g eslint prettier @eslint/create-config
        
        # Go linters
        go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
        
        # Java linters (checkstyle)
        wget -q https://github.com/checkstyle/checkstyle/releases/download/checkstyle-10.12.4/checkstyle-10.12.4-all.jar -O checkstyle.jar
        
        echo "‚úÖ All linters installed successfully!"

    - name: üßπ Run Lint Tests
      if: steps.changes.outputs.has_code_files == 'true'
      run: |
        echo "üîç Running lint tests on changed files..."
        
        lint_success=0
        lint_total=0
        
        while IFS= read -r file; do
          if [ ! -f "$file" ]; then
            continue
          fi
          
          echo "üîç Linting: $file"
          lint_total=$((lint_total + 1))
          
                     case "$file" in
             *.py)
               echo "üêç Running Python linters via script..."
               if ./scripts/lint_python.sh "$file"; then
                 echo "‚úÖ $file passed Python lint"
                 lint_success=$((lint_success + 1))
               else
                 echo "‚ùå $file failed Python lint"
               fi
               ;;
                             
            *.js)
              echo "üöÄ Running JavaScript linters..."
              lint_passed=true
              
              # ESLint (if .eslintrc exists or create basic config)
              if [ ! -f ".eslintrc.json" ] && [ ! -f ".eslintrc.js" ]; then
                echo '{"extends": ["eslint:recommended"], "env": {"node": true, "es6": true}, "parserOptions": {"ecmaVersion": 2022}}' > .eslintrc.json
              fi
              
              if ! npx eslint "$file"; then
                echo "‚ùå ESLint issues found in $file"
                lint_passed=false
              fi
              
              # Prettier (formatter check)
              if ! npx prettier --check "$file"; then
                echo "‚ùå Prettier formatting issues found in $file"
                lint_passed=false
              fi
              
              if $lint_passed; then
                echo "‚úÖ $file passed JavaScript lint"
                lint_success=$((lint_success + 1))
              fi
              ;;
              
            *.java)
              echo "‚òï Running Java linters..."
              lint_passed=true
              
              # Create basic checkstyle config if not exists
              if [ ! -f "checkstyle.xml" ]; then
                cat > checkstyle.xml << 'EOF'
<?xml version="1.0"?>
<!DOCTYPE module PUBLIC "-//Checkstyle//DTD Checkstyle Configuration 1.3//EN" "https://checkstyle.org/dtds/configuration_1_3.dtd">
<module name="Checker">
  <module name="TreeWalker">
    <module name="UnusedImports"/>
    <module name="RedundantImport"/>
    <module name="IllegalImport"/>
    <module name="AvoidStarImport"/>
    <module name="ConstantName"/>
    <module name="LocalFinalVariableName"/>
    <module name="LocalVariableName"/>
    <module name="MemberName"/>
    <module name="MethodName"/>
    <module name="PackageName"/>
    <module name="ParameterName"/>
    <module name="StaticVariableName"/>
    <module name="TypeName"/>
  </module>
</module>
EOF
              fi
              
              if ! java -jar checkstyle.jar -c checkstyle.xml "$file"; then
                echo "‚ùå Checkstyle issues found in $file"
                lint_passed=false
              fi
              
              if $lint_passed; then
                echo "‚úÖ $file passed Java lint"
                lint_success=$((lint_success + 1))
              fi
              ;;
              
            *.go)
              echo "üêπ Running Go linters..."
              lint_passed=true
              
              # gofmt (formatter check)
              if [ "$(gofmt -l "$file")" ]; then
                echo "‚ùå Go formatting issues found in $file"
                gofmt -d "$file"
                lint_passed=false
              fi
              
              # golangci-lint
              if ! golangci-lint run "$file"; then
                echo "‚ùå Golangci-lint issues found in $file"
                lint_passed=false
              fi
              
              if $lint_passed; then
                echo "‚úÖ $file passed Go lint"
                lint_success=$((lint_success + 1))
              fi
              ;;
              
            *)
              echo "‚ö†Ô∏è $file: No linter configured for this file type"
              lint_success=$((lint_success + 1))  # Skip unknown files
              ;;
          esac
          echo "---"
        done < code_files.txt
        
        echo "üîç Lint Results Summary:"
        echo "- Total files linted: $lint_total"
        echo "- Files passed: $lint_success"
        echo "- Files failed: $((lint_total - lint_success))"
        
        if [ $lint_success -eq $lint_total ]; then
          echo "‚úÖ All files passed lint checks!"
        else
          echo "‚ùå Some files failed lint checks."
          exit 1
        fi

    - name: üß™ Run Code Tests
      if: steps.changes.outputs.has_code_files == 'true'
      run: |
        echo "üîç ÏΩîÎìú ÌååÏùº Ïã§Ìñâ Î∞è Í≤ÄÏ¶ù ÏãúÏûë..."
        
        success_count=0
        total_count=0
        
        while IFS= read -r file; do
          if [ ! -f "$file" ]; then
            continue
          fi
          
          echo "üìÑ Testing: $file"
          total_count=$((total_count + 1))
          
          # ÌååÏùº ÌôïÏû•ÏûêÏóê Îî∞Îùº Ïã§Ìñâ
          case "$file" in
            *.py)
              echo "üêç Running Python file..."
              if timeout 30s python3 "$file"; then
                echo "‚úÖ $file Ïã§Ìñâ ÏÑ±Í≥µ"
                success_count=$((success_count + 1))
              else
                echo "‚ùå $file Ïã§Ìñâ Ïã§Ìå®"
              fi
              ;;
            *.java)
              echo "‚òï Running Java file..."
              class_name=$(basename "$file" .java)
              if javac "$file" && timeout 30s java "$class_name"; then
                echo "‚úÖ $file Ïã§Ìñâ ÏÑ±Í≥µ"
                success_count=$((success_count + 1))
              else
                echo "‚ùå $file Ïã§Ìñâ Ïã§Ìå®"
              fi
              ;;
            *.js)
              echo "üöÄ Running JavaScript file..."
              if timeout 30s node "$file"; then
                echo "‚úÖ $file Ïã§Ìñâ ÏÑ±Í≥µ"
                success_count=$((success_count + 1))
              else
                echo "‚ùå $file Ïã§Ìñâ Ïã§Ìå®"
              fi
              ;;
                        *.go)
              echo "üêπ Running Go file..."
              if timeout 30s go run "$file"; then
                echo "‚úÖ $file Ïã§Ìñâ ÏÑ±Í≥µ"
                success_count=$((success_count + 1))
              else
                echo "‚ùå $file Ïã§Ìñâ Ïã§Ìå®"
              fi
              ;;
            *)
              echo "‚ö†Ô∏è $file: ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÌååÏùº ÌòïÏãù"
              ;;
          esac
          echo "---"
        done < code_files.txt
        
        echo "üìä Í≤∞Í≥º ÏöîÏïΩ:"
        echo "- Ï¥ù ÌååÏùº Ïàò: $total_count"
        echo "- ÏÑ±Í≥µÌïú ÌååÏùº: $success_count"
        echo "- Ïã§Ìå®Ìïú ÌååÏùº: $((total_count - success_count))"
        
        if [ $success_count -eq $total_count ] && [ $total_count -gt 0 ]; then
          echo "üéâ Î™®Îì† ÏΩîÎìú ÌååÏùºÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ïã§ÌñâÎêòÏóàÏäµÎãàÎã§!"
          exit 0
        elif [ $total_count -eq 0 ]; then
          echo "‚ÑπÔ∏è Ïã§ÌñâÌï† ÏΩîÎìú ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§."
          exit 0
        else
          echo "üí• ÏùºÎ∂Ä ÏΩîÎìú ÌååÏùº Ïã§ÌñâÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§."
          exit 1
        fi

    - name: üìù Comment on PR
      if: github.event_name == 'pull_request' && steps.changes.outputs.has_code_files == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // ÏõåÌÅ¨ÌîåÎ°úÏö∞ Í≤∞Í≥ºÏóê Îî∞Î•∏ ÏΩîÎ©òÌä∏ ÏÉùÏÑ±
          const workflowUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
          
          let comment = `## üîç ÏΩîÎî© ÌÖåÏä§Ìä∏ Í≤ÄÏ¶ù Í≤∞Í≥º\n\n`;
          comment += `ÏûêÎèôÏúºÎ°ú ÏΩîÎìúÎ•º Ïã§ÌñâÌïòÏó¨ Í≤ÄÏ¶ùÌñàÏäµÎãàÎã§.\n\n`;
          comment += `üìä [ÏÉÅÏÑ∏ Í≤∞Í≥º Î≥¥Í∏∞](${workflowUrl})\n\n`;
          
          if (process.env.GITHUB_JOB_STATUS === 'success') {
            comment += `‚úÖ **Î™®Îì† ÏΩîÎìúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ïã§ÌñâÎêòÏóàÏäµÎãàÎã§!**\n`;
          } else {
            comment += `‚ùå **ÏùºÎ∂Ä ÏΩîÎìú Ïã§ÌñâÏóê Î¨∏Ï†úÍ∞Ä ÏûàÏäµÎãàÎã§.**\n`;
            comment += `ÏúÑ ÎßÅÌÅ¨ÏóêÏÑú ÏÉÅÏÑ∏Ìïú Ïò§Î•ò ÎÇ¥Ïö©ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.\n`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          }); 