# Week 5
# 광고 클릭 수집기(Ad Click Aggregator) 시스템 설계 요약

## 1. 시스템 설계 프레임워크
1. 요구사항 정의
    - 기능적 요구사항 (Functional Requirements)
    - 비기능적 요구사항 (Non-functional Requirements)
2. 시스템 인터페이스 및 데이터 흐름 정의
3. 상위 수준 아키텍처 설계 (High-Level Design)
4. 세부 설계 (Deep Dive)

---

## 2. 기능적 요구사항

- 사용자가 광고를 클릭하면 광고주 웹사이트로 리디렉션되어야 한다.
- 광고주는 자신의 광고 클릭 수를 시간대별로 조회할 수 있어야 한다.
    - 최소 집계 단위는 1분이다.

> 다음 항목은 범위에서 제외:
> - 광고 타게팅 및 노출 결정
> - 디바이스 간 추적 및 오프라인 채널 연동

---

## 3. 비기능적 요구사항

- **확장성**: 초당 10,000건의 클릭, 1,000만 개의 광고 지원
- **낮은 지연 시간**: 분석 쿼리 응답은 1초 이내
- **내결함성 및 데이터 무결성**: 클릭 데이터 손실 없음
- **실시간성**: 최대한 최신의 분석 데이터를 제공
- **멱등성**: 동일한 사용자의 반복 클릭은 1회로 처리

---

## 4. 시스템 인터페이스 및 데이터 흐름

### 입력
- 사용자 클릭 이벤트
- 광고주의 클릭 통계 쿼리 요청

### 출력
- 사용자: 광고주 사이트로 302 Redirect
- 광고주: 집계된 클릭 수 리포트

### 데이터 흐름 단계

1. 클릭 이벤트 수신
2. 사용자 리디렉션 처리
3. 클릭 중복 여부 확인 (멱등성)
4. 클릭 로그 저장
5. 클릭 수 집계
6. 광고주 쿼리 응답

---

## 5. 상위 수준 아키텍처 (High-Level Design)

- 광고 클릭 시 서버에서 redirect URL 조회 후 HTTP 302 응답
- 클릭 로그는 Kinesis Stream을 통해 Flink로 전달
- Flink는 1분 단위로 클릭 수 집계 후 OLAP DB에 저장
- 광고주는 OLAP DB를 조회해 분석 쿼리를 수행

---

## 6. 세부 설계 (Deep Dive)

### 6-1. 실시간 집계 처리

- Flink Stream Aggregation 사용 (1분 집계 창, 10초 flush)
- 빠르게 변화하는 광고 성과 데이터를 실시간으로 반영

### 6-2. 확장성 대응

- Click Processor, Flink 작업자, OLAP DB는 수평 확장 가능
- Kinesis Stream은 광고 ID로 샤딩
- Hot 광고에 대한 샤딩 이슈는 `adId + 해시 값`으로 해결

### 6-3. 내결함성과 데이터 무결성

- Kinesis 7일 보존 설정 (Retention Policy)
- Flink는 Checkpoint 생략 (1분 집계창 기준, 부하 대비 효과 적음)
- S3로 로그 백업 + Spark MapReduce 작업으로 주기적 재검증
- Spark 결과와 OLAP DB 결과 비교 → 불일치 시 수정 및 경고

### 6-4. 클릭 멱등성 처리

- 광고 노출 시 고유한 `adImpressionId` + 서명된 토큰 전달
- Click Processor에서 Redis로 중복 클릭 확인
- 서명된 토큰 유효성 검증 → 위조 방지

---

## 7. 아키텍처 요약

- 실시간 스트림 처리 + 배치 검증을 결합한 **하이브리드 아키텍처**
- Flink로 1분 단위 실시간 집계, Spark로 일간 정확도 검증
- Redis와 서명을 통한 보안 강화 및 중복 클릭 방지

---

## 8. 설계 전략 요약

- 기능적 요구 → 흐름 구성 → 아키텍처 설계 → 비기능 요구 해결
- 무조건 최신 기술보다, **왜 이 기술을 선택했는지** 설명할 수 있어야 함
- 필요 이상으로 계산하거나 구현 디테일에 매몰되지 말 것
